<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>RAID5 btrfs total failure and subsequent abandonment - lazytree</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/btrfs_total_failure.html">

        <meta name="author" content="Kevin Faulkner" />
        <meta name="keywords" content="Linux,btrfs" />
        <meta name="description" content="btrfs RAID 5 fails entirely and takes my data with it" />

        <meta property="og:site_name" content="lazytree" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="RAID5 btrfs total failure and subsequent abandonment"/>
        <meta property="og:url" content="/btrfs_total_failure.html"/>
        <meta property="og:description" content="btrfs RAID 5 fails entirely and takes my data with it"/>
        <meta property="article:published_time" content="2016-03-30" />
            <meta property="article:section" content="devops" />
            <meta property="article:tag" content="Linux" />
            <meta property="article:tag" content="btrfs" />
            <meta property="article:author" content="Kevin Faulkner" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
lazytree            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="/category/devops.html">Devops</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/btrfs_total_failure.html"
                       rel="bookmark"
                       title="Permalink to RAID5 btrfs total failure and subsequent abandonment">
                        RAID5 btrfs total failure and subsequent abandonment
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-03-30T22:16:56-04:00"> Wed 30 March 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/linux.html">Linux</a>
        /
	<a href="/tag/btrfs.html">btrfs</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>My btrfs volume failed last night. I tried to rebalance the array to a &quot;JBOD&quot; (just a bunch of disks), it seems that it failed during that rebalance. To really drill down into the failure, it seems based on lines of the device info (bdev...) both those devices have errors. I suspect that these one batch of these read errors were directly due to the failure last time, (this one has rd 76 corrupt 16, other one had corrupt 8 and read 76). Two &quot;failed&quot; devices, during the course of a rebalance, where I was trying to change the structure of the file system. I think I screwed myself over. I would have thought, based on my last rebalance that it would have refused to run, due to fact that there were bad checksums/errors on the device. I have remembered that btrfs took a very long time to get a check/repair ability (fsck), and that was one reason why ext4 was used in <cite>Fedora 24 &lt;https://www.reddit.com/r/linux/comments/3awppp/btrfs_as_default_filesystem_for_fedora_23/&gt;</cite>, although OpenSUSE has made it the default.</p>
<p>My next filesystem for my movie backups, Virtual Machine images, and other files, will probably be ZFS. I remember being told about ZFS back in 2006. I remember just being awe of that filesystem, mostly the fact that it had RAIDz, compression, checksumming, I didn't know a lot about the details of it but it sounded like a comprehensive filesystem. I was wanting to try it but never had the ability to use it, and then I tried to purchase spare Solaris machines on eBay. I was told never to even look at the source code of ZFS or OpenSolaris due to CDDL (I'm not a lawyer, I know the man's intent was good, but it might have been an exaggeration). But this isn't stopping me from trying to run it on Linux now, one difference that I'm not looking forward to is that there is no defragmentation support (neither offline or online, just doesn't exist), and there is no ability to change the file system type like you can with btrfs (even though that is the part that seemed to fail on me). This file system is going to be a secondary file system on my machine, so it being a tainted 3rd party kernel module is not a concern to me. Also another point is that you need ECC memory, which I have on this machine. Considering all that I should be good with ZFS. I will try to post my experiences with it.</p>
<p>Here is the actions I took and most of the output, if anyone comes to this post from a search engine, my volume failed I did not recover the data:
.. code-block:: console</p>
<blockquote>
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]# btrfs balance start -dconvert=single /mnt/extra/
ERROR: error during balancing '/mnt/extra/': Read-only file system
There may be more info in syslog - try dmesg | tail
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]#
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]# dmesg | tail
[ 3710.919178] &nbsp;[&lt;ffffffff8f1f4d3d&gt;] ? __vma_link_rb+0xfd/0x110
[ 3710.919182] &nbsp;[&lt;ffffffff8f25b4b2&gt;] do_vfs_ioctl+0xa2/0x5d0
[ 3710.919186] &nbsp;[&lt;ffffffff8f062776&gt;] ? __do_page_fault+0x206/0x4d0
[ 3710.919190] &nbsp;[&lt;ffffffff8f25ba59&gt;] SyS_ioctl+0x79/0x90
[ 3710.919196] &nbsp;[&lt;ffffffff8f7ec572&gt;] entry_SYSCALL_64_fastpath+0x1a/0xa4
[ 3710.919228] ---[ end trace 58ee1a8a51b783ac ]---
[ 3710.919232] BTRFS: error (device sdf) in btrfs_run_delayed_refs:2963: errno=-5 IO failure
[ 3710.919235] BTRFS info (device sdf): forced readonly
[ 3734.949833] BTRFS info (device sdg1): disk space caching is enabled
[ 3734.949839] BTRFS info (device sdg1): has skinny extents
[ &nbsp; 71.460425] BTRFS info (device sdb): disk space caching is enabled
[ &nbsp; 71.460433] BTRFS info (device sdb): has skinny extents
[ &nbsp; 72.576302] BTRFS info (device sdb): bdev /dev/sdd errs: wr 0, rd 76, flush 0, corrupt 16, gen 0
[ &nbsp; 72.576311] BTRFS info (device sdb): bdev /dev/sdf errs: wr 510, rd 158743, flush 170, corrupt 0, gen 0
[ &nbsp; 78.476016] BTRFS error (device sdb): parent transid verify failed on 12670714019840 wanted 95664 found 90828
[ &nbsp; 78.488997] BTRFS error (device sdb): parent transid verify failed on 12670714019840 wanted 95664 found 90828
[ &nbsp; 78.489007] BTRFS error (device sdb): failed to read block groups: -5
[ &nbsp; 78.507884] BTRFS: open_ctree failed
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]# mount -o degraded /dev/sdf /mnt/extra/
mount: wrong fs type, bad option, bad superblock on /dev/sdf,
&nbsp; &nbsp; &nbsp; missing codepage or helper program, or other error
&nbsp; &nbsp; &nbsp; In some cases useful info is found in syslog - try
&nbsp; &nbsp; &nbsp; dmesg | tail or so.
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]#
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]# btrfsck --repair --init-csum-tree /dev/sdb
enabling repair mode
Creating a new CRC tree
parent transid verify failed on 12670714019840 wanted 95664 found 90828
parent transid verify failed on 12670714019840 wanted 95664 found 90828
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
leaf parent key incorrect 12670714019840
Checking filesystem on /dev/sdb
UUID: 8289c25f-a8d1-44aa-8c18-6215831d2cae
Reinit crc root
parent transid verify failed on 12670694375424 wanted 95645 found 90828
parent transid verify failed on 12670694375424 wanted 95645 found 90828
parent transid verify failed on 12670694375424 wanted 95645 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670713872384 wanted 95664 found 90828
parent transid verify failed on 12670713872384 wanted 95664 found 90828
bytenr mismatch, want=12670713872384, have=12670713741312
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670714019840 wanted 95664 found 90828
Ignoring transid failure
parent transid verify failed on 12670713872384 wanted 95664 found 90828
parent transid verify failed on 12670713872384 wanted 95664 found 90828
bytenr mismatch, want=12670713872384, have=12670713741312
Unable to find block group for 0
extent-tree.c:289: find_search_start: Assertion <cite>1</cite> failed.
btrfs check(+0x4e29a)[0x556fccd8d29a]
btrfs check(btrfs_reserve_extent+0xabe)[0x556fccd9215e]
btrfs check(btrfs_alloc_free_block+0x5f)[0x556fccd9221f]
btrfs check(+0x46584)[0x556fccd85584]
btrfs check(btrfs_search_slot+0x2a2)[0x556fccd863c2]
btrfs check(btrfs_csum_file_block+0x47f)[0x556fccd9786f]
btrfs check(+0xf67e)[0x556fccd4e67e]
btrfs check(cmd_check+0x27be)[0x556fccd72d4e]
btrfs check(main+0x7d)[0x556fccd4eddd]
/lib64/libc.so.6(__libc_start_main+0xf1)[0x7fb048cd4731]
btrfs check(_start+0x29)[0x556fccd4eee9]
[<a class="reference external" href="mailto:root&#64;horse">root&#64;horse</a> ~]#</blockquote>
<!--  -->

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://joindiaspora.com/people/df70ab403afe0134a2ce0242ac110007"><i class="fa fa-diaspora-square fa-lg"></i> diaspora</a></li>
    <li class="list-group-item"><a href="http://github.com/kondor6c"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://keybase.io/kondor6c"><i class="fa fa-keybase-square fa-lg"></i> keybase</a></li>
    <li class="list-group-item"><a href="https://news.ycombinator.com/user?id=kondor6c"><i class="fa fa-hackernews-square fa-lg"></i> HackerNews</a></li>
    <li class="list-group-item"><a href="https://news.ycombinator.com/user?id=kondor6c"><i class="fa fa-gpodder-square fa-lg"></i> Gpodder</a></li>
    <li class="list-group-item"><a href="https://badges.fedoraproject.org/user/kondor6c"><i class="fa fa-fedora-square fa-lg"></i> Fedora</a></li>
    <li class="list-group-item"><a href="https://www.reddit.com/user/kondor6c/"><i class="fa fa-reddit-square fa-lg"></i> reddit</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://getpelican.com/" target="_blank">Pelican</a>
    </li>
    <li class="list-group-item">
      <a href="#" target="_blank">You can modify those links in your config file</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Kevin Faulkner
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>