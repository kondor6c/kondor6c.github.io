<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>An End of Disk Issues? - lazytree</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/end_of_disk_issues.html">

        <meta name="author" content="Kevin Faulkner" />
        <meta name="keywords" content="Linux,zfs,disk" />
        <meta name="description" content="A hopeful end to disk issues on my workstation and ending with a brief mention of topics to come" />

        <meta property="og:site_name" content="lazytree" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="An End of Disk Issues?"/>
        <meta property="og:url" content="/end_of_disk_issues.html"/>
        <meta property="og:description" content="A hopeful end to disk issues on my workstation and ending with a brief mention of topics to come"/>
        <meta property="article:published_time" content="2018-08-02" />
            <meta property="article:section" content="homelab" />
            <meta property="article:tag" content="Linux" />
            <meta property="article:tag" content="zfs" />
            <meta property="article:tag" content="disk" />
            <meta property="article:author" content="Kevin Faulkner" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
lazytree            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="/category/community-content-ideas-conferences.html">Community, content ideas, conferences</a>
                        </li>
                        <li >
                            <a href="/category/devops.html">Devops</a>
                        </li>
                        <li class="active">
                            <a href="/category/homelab.html">Homelab</a>
                        </li>
                        <li >
                            <a href="/category/infrastructure.html">Infrastructure</a>
                        </li>
                        <li >
                            <a href="/category/personal.html">Personal</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/end_of_disk_issues.html"
                       rel="bookmark"
                       title="Permalink to An End of Disk Issues?">
                        An End of Disk Issues?
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-08-02T11:23:19-04:00"> Thu 02 August 2018</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="/tag/linux.html">Linux</a>
        /
	<a href="/tag/zfs.html">zfs</a>
        /
	<a href="/tag/disk.html">disk</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I have a workstation that I have built, it contains a multi-disk Large Form Factor ZFS array. There have been multiple posts in the past about some of my disk related problems that I've handled, you should be able to find them with a 'zfs' or 'disk' tag. Well I had several issues, that I hope should be calming down; going back to January, where I decided to move from 4x3TB RAID-Z (software RAID 5) to 4x4TB 7200RPM RAID 10 setup. The transition was prompted by this event and I really have written this up to share my experience with others. I spoke casually about this with Jim Salter, Michael Hrivnak, Wes Widner, and several others, but I brought it up mostly because of Jim's project <a href="https://github.com/jimsalterjrs/sanoid">Sanoid</a> and he's presented on ZFS before. I had one disk start clicking when I got back from running, I could see in <code>dmesg</code> that this disk was not responding and was trying to be reset; important thing to point out, ZFS had brought the disk OFFLINE. I had a spare 4TB 'eco' drive that really doesn't deliver the performance that is needed and would hinder the array, but I wanted to get the disk replaced so that I could get another one ordered. Well I hooked the disk up, and started the zfs replace process. I woke up and found that another disk, in this RAID-Z, had reported as failing (FAULTED), all during the replace process. I knew this was very bad, two disks failing, and you can't stop a resilver, but you can stop a scrub, by using <code>zpool scrub -s ${pool}</code>, what I should have done is brought the disk "online" but what I did, could have been worse... I rebooted my workstation! During the resilver/replace process, not my finest hour.
This array doesn't hold too much, but it does hold "warm" backups (staged to go on to different disk stored elsewhere), KVM disk images (virtual machines), and other various data, usually high write IO that I don't want to wear on my SSD/NVMe drive, I could stand to lose this array, but I don't want to because it would be painful. When the machine came back, the pool was imported and the resilver restarted, this time with the clicking disk "ONLINE" however the other faulted disk, was now "UNAVAILABLE", so I have a replace going of an online disk that is in a poor state, but ZFS had recovered from this, and the replace completed successfully. I then transferred the data elsewhere, rebuilt the pool as a RAID-10.
The pool is now with all 7200 RPM disks in a RAID-10 setup. ZFS looks at this as one mirror (RAID 1) with a striped disk set (RAID 0), this might be confusing, I will perhaps try to do a video to cover this more. Here is some output of my now healthy disk status:</p>
<div class="highlight"><pre><span></span>        NAME                        STATE     READ WRITE CKSUM
        extra                       ONLINE       0     0     0
          mirror-0                  ONLINE       0     0     0
            wwn-0x5000cca23dcdcfc7  ONLINE       0     0     0
            wwn-0x5000c500675738ba  ONLINE       0     0     0
          mirror-1                  ONLINE       0     0     0
            wwn-0x5000cca22bc39ed8  ONLINE       0     0     0
            wwn-0x50000397fc580978  ONLINE       0     0     0
</pre></div>


<p>The issue that I think I had encountered for a while, was that I plugged three 4TB 7200RPM disks using the same SATA power plug coming from the power supply. I had thought I was up against a bad controller/port/cable and I plugged a red SATA cable in to signify that "red is dead", but the issue continued when I plugged it into another SATA port. I realized that when I put the hard drive in a top unit or in a USB3 SATA drive, that the disk was fine it didn't even spin cycle. I believe that this new disk array was consuming more power enough that the disk would power on, but upon doing load wouldn't service the ATA commands quick enough, and linux would then reset it. Similar to this</p>
<div class="highlight"><pre><span></span>[Wed Jun  6 12:51:54 2018] ata1: link is slow to respond, please be patient (ready=0)
[Wed Jun  6 12:52:23 2018] ata1: COMRESET failed (errno=-16)
[Wed Jun  6 12:52:23 2018] ata1: hard resetting link
[Wed Jun  6 12:52:28 2018] ata1: COMRESET failed (errno=-16)
[Wed Jun  6 12:52:28 2018] ata1: reset failed, giving up
</pre></div>


<p>Giving this "bad disk" a dedicated power plug resolved these issues. I had a similar issue when adding five 1U HP DL160's to a Cabinet, Friday night I hooked them all up, and we started the HDFS rebalance, but upon getting load on those machines, we got a phone call from Sungard saying that we're exceeding the power limit. Load can influence things, in many ways, I knew this; I guess this one just took me longer to realize.</p>
<p>In other news, I have created a video on my camera showing the process of using a Yubikey and <code>pass</code> to get versioned passwords, but I realized that it was very ad-hoc and I deleted the video. I spent a fair amount of time editing in KDEnlive and audacity, but I just was not pleased with the end product so I will be redoing it and uploading it shortly. I also plan on writing up my home router creation and performance testing of MySQL as I hinted at last blog post. I did some performance testing of docker storage drivers and needless to say we will be avoiding btrfs, I didn't test with <code>nodatacow</code> as a mount option, but really XFS and overlay2 didn't have that option and performed very well. This test wasn't exhaustive, but enough to give an idea and fulfill proper investigation/baselining to change the storage drivers that my employer is using, without getting into too many details, a contractor configured us to use one that should not be used in production.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a href="https://joindiaspora.com/people/df70ab403afe0134a2ce0242ac110007"><i class="fa fa-diaspora-square fa-lg"></i> diaspora</a></li>
    <li class="list-group-item"><a href="http://github.com/kondor6c"><i class="fa fa-github-square fa-lg"></i> github</a></li>
    <li class="list-group-item"><a href="https://keybase.io/kondor6c"><i class="fa fa-keybase-square fa-lg"></i> keybase</a></li>
    <li class="list-group-item"><a href="https://news.ycombinator.com/user?id=kondor6c"><i class="fa fa-hackernews-square fa-lg"></i> HackerNews</a></li>
    <li class="list-group-item"><a href="https://news.ycombinator.com/user?id=kondor6c"><i class="fa fa-gpodder-square fa-lg"></i> Gpodder</a></li>
    <li class="list-group-item"><a href="https://badges.fedoraproject.org/user/kondor6c"><i class="fa fa-fedora-square fa-lg"></i> Fedora</a></li>
    <li class="list-group-item"><a href="https://www.reddit.com/user/kondor6c/"><i class="fa fa-reddit-square fa-lg"></i> reddit</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://getpelican.com/" target="_blank">Pelican</a>
    </li>
    <li class="list-group-item">
      <a href="#" target="_blank">You can modify those links in your config file</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Kevin Faulkner
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>




</body>
</html>